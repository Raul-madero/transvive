<!-- firmar_contrato.html -->
<style>
  .wrap { display:grid; grid-template-columns: 1fr 520px; gap:16px; }
  #signature-pad { border:1px solid #ccc; border-radius:8px; width:500px; height:200px; }
  .sig-actions { margin-top:8px; display:flex; gap:8px; }
</style>

<div class="wrap">
  <div>
    <!-- Vista previa del PDF (el que generas con tu script actual). 
         Puedes pasar ?id=... en la URL para que cargue el contrato correcto -->
    <iframe src="factura/contrato_modificado.php?id=<?=urlencode($_GET['id']??'')?>&preview=1" width="100%" height="700"></iframe>
  </div>

  <div>
    <h3>Firma del empleado</h3>
    <canvas id="signature-pad"></canvas>
    <div class="sig-actions">
      <button type="button" id="clear-btn">Limpiar</button>
      <button type="button" id="use-btn">Usar esta firma</button>
    </div>

    <form id="form-firmar" method="POST" action="factura/firmar_y_guardar.php">
      <!-- identifica el contrato/empleado como ya haces -->
      <input type="hidden" name="id" value="<?=htmlspecialchars($_GET['id']??'')?>">
      <!-- firma base64 -->
      <input type="hidden" name="firma" id="firma-input">
      <!-- opcional: “guardar en servidor” -->
      <label><input type="checkbox" name="guardar" value="1" checked> Guardar firmado en el servidor</label>
      <div style="margin-top:10px">
        <button type="submit">Firmar y descargar PDF</button>
      </div>
    </form>
  </div>
</div>

<script src="https://unpkg.com/signature_pad/dist/signature_pad.umd.min.js"></script>
<script>
  const canvas = document.getElementById('signature-pad');
  const signaturePad = new SignaturePad(canvas, {
    minWidth: 0.8, maxWidth: 2.5, penColor: 'black', backgroundColor: 'rgba(255,255,255,0)'
  });

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width  = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  document.getElementById('clear-btn').onclick = () => signaturePad.clear();
  document.getElementById('use-btn').onclick = () => {
    if (signaturePad.isEmpty()) return alert('Por favor firma en el recuadro.');
    document.getElementById('firma-input').value = signaturePad.toDataURL('image/png');
    alert('Firma capturada. Ahora haz clic en “Firmar y descargar PDF”.');
  };

  document.getElementById('form-firmar').addEventListener('submit', (e) => {
    if (!document.getElementById('firma-input').value) {
      e.preventDefault();
      alert('Captura la firma antes de continuar.');
    }
  });
</script>
